---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await post.render();

// Check if the post is private
const isPrivate = post.data.isPrivate;
const privatePassword = post.data.privatePassword || 'secret';
---

<BaseLayout title={post.data.title} description={post.data.description}>
  {isPrivate && (
    <div id="password-gate" style="max-width: 500px; margin: 3rem auto; padding: 2rem; background: white; border-radius: 8px; box-shadow: var(--box-shadow);">
      <h2>This is a Private Post</h2>
      <p style="margin: 1rem 0; color: rgb(var(--gray));">
        Please enter the password to view this content.
      </p>
      <form id="password-form">
        <input
          type="password"
          id="password-input"
          placeholder="Enter password"
          style="width: 100%; padding: 0.75rem; border: 2px solid rgb(var(--gray-light)); border-radius: 4px; font-size: 1rem; margin-bottom: 1rem;"
        />
        <button
          type="submit"
          style="width: 100%; padding: 0.75rem; background: var(--accent); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; font-weight: 600;"
        >
          Access Post
        </button>
      </form>
      <p id="error-message" style="color: #dc2626; margin-top: 1rem; display: none;">
        Incorrect password. Please try again.
      </p>
    </div>
  )}

  <article id="blog-content" style={isPrivate ? 'display: none;' : ''}>
    <div style="margin-bottom: 2rem;">
      {post.data.heroImage && (
        <img
          src={post.data.heroImage}
          alt={post.data.title}
          style="width: 100%; height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 2rem;"
        />
      )}
      <h1>{post.data.title}</h1>
      <time style="color: rgb(var(--gray)); font-size: 0.9rem;">
        {post.data.pubDate.toLocaleDateString('en-us', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        })}
      </time>
      {post.data.updatedDate && (
        <p style="color: rgb(var(--gray)); font-size: 0.9rem; font-style: italic; margin-top: 0.25rem;">
          Last updated: {post.data.updatedDate.toLocaleDateString('en-us', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })}
        </p>
      )}
    </div>

    <div class="prose">
      <Content />
    </div>
  </article>

  <style>
    .prose {
      line-height: 1.8;
      max-width: 720px;
    }
    .prose :global(h2) {
      font-size: 1.8rem;
      margin-top: 2.5rem;
      margin-bottom: 1rem;
    }
    .prose :global(h3) {
      font-size: 1.4rem;
      margin-top: 2rem;
      margin-bottom: 0.75rem;
    }
    .prose :global(p) {
      margin-bottom: 1.5rem;
    }
    .prose :global(ul), .prose :global(ol) {
      margin-bottom: 1.5rem;
      padding-left: 2rem;
    }
    .prose :global(li) {
      margin-bottom: 0.5rem;
    }
    .prose :global(code) {
      background: rgb(var(--gray-light));
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.9em;
      font-family: 'Courier New', Courier, monospace;
    }
    .prose :global(pre) {
      background: rgb(var(--gray-dark));
      color: rgb(var(--gray-light));
      padding: 1.5rem;
      border-radius: 8px;
      overflow-x: auto;
      margin-bottom: 1.5rem;
    }
    .prose :global(pre code) {
      background: none;
      padding: 0;
      color: inherit;
    }
    .prose :global(blockquote) {
      border-left: 4px solid var(--accent);
      padding-left: 1.5rem;
      margin: 1.5rem 0;
      font-style: italic;
      color: rgb(var(--gray));
    }
    .prose :global(img) {
      border-radius: 8px;
      max-width: 100%;
      height: auto;
      margin: 2rem 0;
    }
    .prose :global(a) {
      color: var(--accent);
      text-decoration: underline;
    }
    .prose :global(a:hover) {
      color: var(--accent-dark);
    }
  </style>

  <script define:vars={{ privatePassword, isPrivate }}>
    if (isPrivate) {
      const form = document.getElementById('password-form');
      const input = document.getElementById('password-input');
      const errorMessage = document.getElementById('error-message');
      const passwordGate = document.getElementById('password-gate');
      const blogContent = document.getElementById('blog-content');

      form?.addEventListener('submit', (e) => {
        e.preventDefault();
        if (input?.value === privatePassword) {
          passwordGate.style.display = 'none';
          blogContent.style.display = 'block';
          errorMessage.style.display = 'none';
        } else {
          errorMessage.style.display = 'block';
        }
      });
    }
  </script>
</BaseLayout>
